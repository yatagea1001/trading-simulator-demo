<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<title>YATA TRADER PRO - Simulator</title>

<style>
/* --- 1. RESET --- */
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
    width: 100%; height: 100%; margin: 0; padding: 0;
    overflow: hidden; background-color: #000;
    font-family: 'Segoe UI', sans-serif;
    touch-action: none; -webkit-user-select: none; user-select: none;
}

/* --- 2. CANVAS UTAMA --- */
canvas.emscripten {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    border: 0 none; background-color: #000; outline: none;
    -webkit-tap-highlight-color: transparent;
    opacity: 0; /* Sembunyi dulu sebelum loading selesai */
    transition: opacity 1s ease-in;
}

/* --- 3. LAYAR LOADING KEREN --- */
#loading-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #050505; z-index: 9999;
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    color: #0af;
    transition: opacity 0.5s ease-out;
}
.spinner {
    width: 50px; height: 50px;
    border: 5px solid rgba(0, 170, 255, 0.2);
    border-top: 5px solid #0af;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.progress-container {
    width: 300px; height: 6px;
    background: #222; border-radius: 3px;
    overflow: hidden; margin-bottom: 10px;
}
#progress-fill {
    width: 0%; height: 100%;
    background: #0af;
    transition: width 0.2s ease-out;
    box-shadow: 0 0 10px #0af;
}
#status-text { font-size: 14px; letter-spacing: 1px; color: #888; }

/* --- 4. TOMBOL FULLSCREEN (POJOK KANAN ATAS) --- */
#btn-fullscreen {
    position: fixed; top: 15px; right: 15px;
    width: 40px; height: 40px;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid #333;
    border-radius: 8px;
    color: #0af;
    font-size: 20px;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer;
    z-index: 5000; /* Di atas canvas */
    transition: background 0.3s;
    opacity: 0; /* Muncul setelah loading selesai */
    pointer-events: none;
}
#btn-fullscreen:hover { background: rgba(0, 170, 255, 0.2); border-color: #0af; }

</style>
</head>

<body>

<div id="loading-screen">
    <div class="spinner"></div>
    <div class="progress-container"><div id="progress-fill"></div></div>
    <div id="status-text">Menyiapkan Engine... 0%</div>
</div>

<div id="btn-fullscreen" onclick="toggleFullScreen()">â›¶</div>

<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>

<script>
    var statusElement = document.getElementById('status-text');
    var progressElement = document.getElementById('progress-fill');
    var loadingScreen = document.getElementById('loading-screen');
    var canvasElement = document.getElementById('canvas');
    var btnFull = document.getElementById('btn-fullscreen');

    // --- FUNGSI FULLSCREEN ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.log(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    var Module = {
        preRun: [],
        postRun: [],
        canvas: (function() {
            var canvas = document.getElementById('canvas');
            canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. Reload page.'); e.preventDefault(); }, false);
            return canvas;
        })(),

        // --- HITUNG PERSEN DOWNLOAD ---
        setStatus: function(text) {
            if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
            if (text === Module.setStatus.last.text) return;
            var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+(\.\d+)?)\)/);
            if (m) {
                var now = Date.now();
                if (now - Module.setStatus.last.time < 30) return; 
                Module.setStatus.last.time = now;
                Module.setStatus.last.text = text;
                var current = parseInt(m[2]); var total = parseInt(m[4]);
                var percent = Math.round((current / total) * 100);
                progressElement.style.width = percent + "%";
                statusElement.innerText = "Mengunduh Data... " + percent + "%";
            } else {
                if (text.length > 0) statusElement.innerText = text;
            }
        },

        // --- KETIKA SELESAI LOAD ---
        onRuntimeInitialized: function() { 
            console.log("[WASM] Engine Siap."); 
            progressElement.style.width = "100%";
            statusElement.innerText = "Membuka Aplikasi...";

            setTimeout(() => {
                loadingScreen.style.opacity = "0"; 
                setTimeout(() => { loadingScreen.style.display = "none"; }, 500); 
                
                canvasElement.style.opacity = "1";
                canvasElement.focus();
                
                // Munculkan Tombol Fullscreen
                btnFull.style.opacity = "1";
                btnFull.style.pointerEvents = "auto";
            }, 500);

            if (Module._wasm_on_login_success) Module._wasm_on_login_success();
            if (typeof connectWS === 'function') connectWS();
        }
    };
    
    window.onerror = function(event) {
        statusElement.innerText = "Error: " + event;
        statusElement.style.color = "red";
    };
</script>

<script>
    // --- INPUT HANDLING (Sama, Tidak Ada Perubahan) ---
    // Copy bagian bridge wasm, mouse, touch, dan keyboard dari kode sebelumnya ke sini
    // (Bagian ini sama persis dengan yang sudah jalan, supaya tidak kepanjangan saya singkat di chat ini)
    // TAPI PASTIIN KAMU TETAP PAKAI LOGIKA INPUT YANG TADI YA!
    
    window.notifyWASM_candle = function(o,h,l,c,t,v){
        if (Module.ccall) Module.ccall("wasm_push_candle", null, ["number","number","number","number","number","number"], [o,h,l,c,t,v]);
    };
    window.notifyWASM_tick = function(price,time){
        if (Module.ccall) Module.ccall("wasm_push_tick", null, ["number","number"], [price,time]);
    };

   // ====================================================================
    // ðŸ–±ï¸ & ðŸ“± SUPER NATIVE INPUT HANDLING (JARI = MOUSE)
    // ====================================================================
    var canvas = document.getElementById("canvas");
    var isTouching = false; 
    var lastTouchX = null, lastTouchY = null, lastPinchDist = null;

    function getScale() {
        var rect = canvas.getBoundingClientRect();
        return { x: canvas.width / rect.width, y: canvas.height / rect.height };
    }
    function getPinchDist(t1, t2) {
        return Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
    }

    // --- 1. MOUSE (PC) ---
    // Kita cegat Mouse Event jika user sedang pakai Touchscreen (supaya tidak double click)
    canvas.addEventListener('mousemove', function(e) {
        if (isTouching) return; 
        var rect = canvas.getBoundingClientRect(); var s = getScale();
        if (Module.ccall) Module.ccall('wasm_mouse_move', null, ['number', 'number'], [(e.clientX - rect.left)*s.x, (e.clientY - rect.top)*s.y]);
    });
    canvas.addEventListener('mousedown', function(e) {
        if (isTouching) { e.preventDefault(); return; } // ðŸ”¥ Stop Ghost Click
        if (Module.ccall) Module.ccall('wasm_mouse_click', null, ['number', 'number'], [e.button, 1]); 
    }, {passive: false});
    canvas.addEventListener('mouseup', function(e) {
        if (isTouching) { e.preventDefault(); return; } // ðŸ”¥ Stop Ghost Click
        if (Module.ccall) Module.ccall('wasm_mouse_click', null, ['number', 'number'], [e.button, 0]); 
    }, {passive: false});
    canvas.addEventListener('wheel', function(e) {
        e.preventDefault();
        if (Module.ccall) Module.ccall('wasm_mouse_wheel', null, ['number'], [Math.sign(e.deltaY) * -1]);
    }, {passive: false});
    canvas.addEventListener('contextmenu', function(e) { e.preventDefault(); }, false);

    // --- 2. TOUCH (JARI -> MOUSE SIMULATOR) ---
    // Ini rahasianya agar drawing berfungsi saat disentuh
    
    canvas.addEventListener('touchstart', function(e) {
        if(e.cancelable) e.preventDefault(); // ðŸ”¥ Matikan scroll/zoom browser
        isTouching = true;
        
        var rect = canvas.getBoundingClientRect(); var s = getScale();

        if (e.touches.length === 1) {
            // SINGLE TOUCH (Simulasi Mouse Kiri Klik)
            var touch = e.touches[0];
            var x = (touch.clientX - rect.left) * s.x;
            var y = (touch.clientY - rect.top) * s.y;
            
            lastTouchX = touch.clientX; lastTouchY = touch.clientY; lastPinchDist = null;

            if (Module.ccall) {
                // ðŸ”¥ LANGKAH 1: Teleport Kursor Mouse Virtual ke posisi jari DULUAN
                Module.ccall('wasm_mouse_move', null, ['number', 'number'], [x, y]);
                // ðŸ”¥ LANGKAH 2: Baru tekan tombol "Klik Kiri" (1 = Down)
                Module.ccall('wasm_mouse_click', null, ['number', 'number'], [0, 1]); 
                
                // Opsional: Kirim raw touch start buat logic lain
                Module.ccall('wasm_notify_touch_start', null, ['number', 'number'], [x, y]);
            }
        } else if (e.touches.length === 2) {
            // DUAL TOUCH (Zoom / Pan - Lepas Klik Mouse)
            if (Module.ccall) Module.ccall('wasm_mouse_click', null, ['number', 'number'], [0, 0]);
            lastPinchDist = getPinchDist(e.touches[0], e.touches[1]);
            lastTouchX = null; lastTouchY = null;
        }
    }, {passive: false});

    canvas.addEventListener('touchmove', function(e) {
        if (e.cancelable) e.preventDefault(); 
        var rect = canvas.getBoundingClientRect(); var s = getScale();

        if (e.touches.length === 2 && lastPinchDist !== null) {
            // --- ZOOM LOGIC ---
            var currentDist = getPinchDist(e.touches[0], e.touches[1]);
            var deltaZoom = (currentDist - lastPinchDist) * s.x;
            if (Module.ccall) Module.ccall('wasm_zoom_chart', null, ['number'], [deltaZoom]);
            lastPinchDist = currentDist; 
        } 
        else if (e.touches.length === 1 && lastTouchX !== null) {
            // --- DRAG / DRAW LOGIC ---
            var touch = e.touches[0];
            var x = (touch.clientX - rect.left) * s.x;
            var y = (touch.clientY - rect.top) * s.y;
            
            // Hitung delta untuk Pan Chart
            var deltaX = touch.clientX - lastTouchX; 
            var deltaY = touch.clientY - lastTouchY;

            if (Module.ccall) {
                // 1. Update posisi mouse virtual (PENTING BUAT DRAWING TOOLS)
                Module.ccall('wasm_mouse_move', null, ['number', 'number'], [x, y]);
                
                // 2. Kirim sinyal Pan (Geser Chart) 
                // Catatan: Di main.cpp, pastikan logika "Jika sedang Drawing, Jangan Pan Chart"
                Module.ccall('wasm_pan_chart_pixels', null, ['number', 'number'], [deltaX, deltaY]);
            }
            lastTouchX = touch.clientX; lastTouchY = touch.clientY;
        }
    }, {passive: false});

    canvas.addEventListener('touchend', function(e) {
        if (e.cancelable) e.preventDefault();
        
        // ðŸ”¥ LEPAS KLIK MOUSE (0 = Up)
        if (Module.ccall) Module.ccall('wasm_mouse_click', null, ['number', 'number'], [0, 0]);
        
        if (e.touches.length < 2) lastPinchDist = null;
        if (e.touches.length === 0) { 
            lastTouchX = null; lastTouchY = null; 
            // Reset status touch sedikit delay untuk mencegah ghost click mouse
            setTimeout(() => { isTouching = false; }, 300); 
        }
    }, {passive: false});

    // KEYBOARD
    window.addEventListener('keydown', function(e) {
        if (!Module.ccall) return;
        if (e.keyCode === 8 || e.keyCode === 9) e.preventDefault(); 
        Module.ccall('wasm_send_key', null, ['number', 'number'], [e.keyCode, 1]);
        if (e.ctrlKey) Module.ccall('wasm_send_key', null, ['number', 'number'], [17, 1]); 
    });
    window.addEventListener('keyup', function(e) {
        if (!Module.ccall) return;
        Module.ccall('wasm_send_key', null, ['number', 'number'], [e.keyCode, 0]);
    });
    window.addEventListener('keypress', function(e) {
        if (!Module.ccall) return;
        Module.ccall('wasm_send_char', null, ['number'], [e.charCode]);
    });
</script>

<script src="websocket.js"></script>    
<script src="index.js"></script>
<script src="my_dev_logic.js"></script>

</body>
</html>