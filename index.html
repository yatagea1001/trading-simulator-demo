<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>YATA TRADER PRO - Demo Simulator</title>

<style>
/* --- 1. RESET STANDAR BROWSER --- */
* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
    width: 100%; height: 100%;
    margin: 0; padding: 0;
    overflow: hidden; /* Anti Scroll */
    background-color: #000;
    font-family: 'Segoe UI', sans-serif;
    /* üî• PENTING: Matikan semua gesture bawaan browser (zoom/swipe back) */
    touch-action: none; 
    -webkit-user-select: none; /* Matikan blok teks */
    user-select: none;
}

/* --- 2. CANVAS STANDAR --- */
canvas.emscripten {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border: 0 none;
    background-color: #000;
    outline: none;
    /* Hilangkan highlight biru saat tap di Android */
    -webkit-tap-highlight-color: transparent; 
    
    /* üî• LANGSUNG MUNCUL (Tanpa Fade In Login) */
    opacity: 1; 
}

/* --- LOADING SPINNER --- */
#loading-spinner {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    color: #0af; font-family: sans-serif; font-size: 14px; 
    z-index: 9999; pointer-events: none;
    font-weight: bold; letter-spacing: 1px;
}
</style>
</head>

<body>

<div id="loading-spinner">
    üöÄ MEMUAT SIMULATOR...
</div>

<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>

<script>
    var Module = {
        preRun: [],
        postRun: [],
        canvas: (function() {
            var canvas = document.getElementById('canvas');
            canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. Reload page.'); e.preventDefault(); }, false);
            return canvas;
        })(),
        onRuntimeInitialized: function() { 
            console.log("[WASM] Engine Loaded."); 
            
            // 1. Hilangkan Loading Spinner
            var spinner = document.getElementById('loading-spinner');
            if(spinner) spinner.style.display = 'none';

            // 2. üî• BYPASS LOGIN: Langsung beri sinyal ke C++ bahwa user sudah "Masuk"
            // Agar chart langsung dirender tanpa menunggu input password
            if (Module._wasm_on_login_success) {
                Module._wasm_on_login_success();
            }

            // 3. Fokus ke canvas agar keyboard langsung jalan
            document.getElementById("canvas").focus();

            // 4. Koneksi WebSocket (Jika ada logic auto-connect untuk data dummy)
            if (typeof connectWS === 'function') {
                connectWS();
            }
        }
    };
    
    window.onerror = function(event) { console.error("Window Error: " + event); };
</script>

<script>
    // --- BRIDGE WASM ---
    window.notifyWASM_candle = function(o,h,l,c,t,v){
        if (Module.ccall) Module.ccall("wasm_push_candle", null, ["number","number","number","number","number","number"], [o,h,l,c,t,v]);
    };
    window.notifyWASM_tick = function(price,time){
        if (Module.ccall) Module.ccall("wasm_push_tick", null, ["number","number"], [price,time]);
    };
    
    // ====================================================================
    // üñ±Ô∏è & üì± SUPER NATIVE INPUT HANDLING (JARI = MOUSE)
    // ====================================================================
    var canvas = document.getElementById("canvas");
    var isTouching = false; 
    var lastTouchX = null, lastTouchY = null, lastPinchDist = null;

    function getScale() {
        var rect = canvas.getBoundingClientRect();
        return { x: canvas.width / rect.width, y: canvas.height / rect.height };
    }
    function getPinchDist(t1, t2) {
        return Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
    }

    // --- 1. MOUSE (PC) ---
    canvas.addEventListener('mousemove', function(e) {
        if (isTouching) return; 
        var rect = canvas.getBoundingClientRect(); var s = getScale();
        if (Module.ccall) Module.ccall('wasm_mouse_move', null, ['number', 'number'], [(e.clientX - rect.left)*s.x, (e.clientY - rect.top)*s.y]);
    });
    canvas.addEventListener('mousedown', function(e) {
        if (isTouching) { e.preventDefault(); return; }
        if (Module.ccall) Module.ccall('wasm_mouse_click', null, ['number', 'number'], [e.button, 1]); 
    }, {passive: false});
    canvas.addEventListener('mouseup', function(e) {
        if (isTouching) { e.preventDefault(); return; }
        if (Module.ccall) Module.ccall('wasm_mouse_click', null, ['number', 'number'], [e.button, 0]); 
    }, {passive: false});
    canvas.addEventListener('wheel', function(e) {
        e.preventDefault();
        if (Module.ccall) Module.ccall('wasm_mouse_wheel', null, ['number'], [Math.sign(e.deltaY) * -1]);
    }, {passive: false});
    canvas.addEventListener('contextmenu', function(e) { e.preventDefault(); }, false);

    // --- 2. TOUCH (MOBILE) ---
    canvas.addEventListener('touchstart', function(e) {
        if(e.cancelable) e.preventDefault(); 
        isTouching = true;
        
        var rect = canvas.getBoundingClientRect(); var s = getScale();

        if (e.touches.length === 1) {
            var touch = e.touches[0];
            var x = (touch.clientX - rect.left) * s.x;
            var y = (touch.clientY - rect.top) * s.y;
            
            lastTouchX = touch.clientX; lastTouchY = touch.clientY; lastPinchDist = null;

            if (Module.ccall) {
                Module.ccall('wasm_mouse_move', null, ['number', 'number'], [x, y]);
                Module.ccall('wasm_mouse_click', null, ['number', 'number'], [0, 1]); 
                Module.ccall('wasm_notify_touch_start', null, ['number', 'number'], [x, y]);
            }
        } else if (e.touches.length === 2) {
            if (Module.ccall) Module.ccall('wasm_mouse_click', null, ['number', 'number'], [0, 0]);
            lastPinchDist = getPinchDist(e.touches[0], e.touches[1]);
            lastTouchX = null; lastTouchY = null;
        }
    }, {passive: false});

    canvas.addEventListener('touchmove', function(e) {
        if (e.cancelable) e.preventDefault(); 
        var rect = canvas.getBoundingClientRect(); var s = getScale();

        if (e.touches.length === 2 && lastPinchDist !== null) {
            var currentDist = getPinchDist(e.touches[0], e.touches[1]);
            var deltaZoom = (currentDist - lastPinchDist) * s.x;
            if (Module.ccall) Module.ccall('wasm_zoom_chart', null, ['number'], [deltaZoom]);
            lastPinchDist = currentDist; 
        } 
        else if (e.touches.length === 1 && lastTouchX !== null) {
            var touch = e.touches[0];
            var x = (touch.clientX - rect.left) * s.x;
            var y = (touch.clientY - rect.top) * s.y;
            var deltaX = touch.clientX - lastTouchX; 
            var deltaY = touch.clientY - lastTouchY;

            if (Module.ccall) {
                Module.ccall('wasm_mouse_move', null, ['number', 'number'], [x, y]);
                Module.ccall('wasm_pan_chart_pixels', null, ['number', 'number'], [deltaX, deltaY]);
            }
            lastTouchX = touch.clientX; lastTouchY = touch.clientY;
        }
    }, {passive: false});

    canvas.addEventListener('touchend', function(e) {
        if (e.cancelable) e.preventDefault();
        if (Module.ccall) Module.ccall('wasm_mouse_click', null, ['number', 'number'], [0, 0]);
        if (e.touches.length < 2) lastPinchDist = null;
        if (e.touches.length === 0) { 
            lastTouchX = null; lastTouchY = null; 
            setTimeout(() => { isTouching = false; }, 300); 
        }
    }, {passive: false});

    // --- KEYBOARD HANDLING ---
    window.addEventListener('keydown', function(e) {
        if (!Module.ccall) return;
        if (e.keyCode === 8 || e.keyCode === 9) e.preventDefault(); 
        Module.ccall('wasm_send_key', null, ['number', 'number'], [e.keyCode, 1]);
        if (e.ctrlKey) Module.ccall('wasm_send_key', null, ['number', 'number'], [17, 1]); 
    });
    window.addEventListener('keyup', function(e) {
        if (!Module.ccall) return;
        Module.ccall('wasm_send_key', null, ['number', 'number'], [e.keyCode, 0]);
    });
    window.addEventListener('keypress', function(e) {
        if (!Module.ccall) return;
        Module.ccall('wasm_send_char', null, ['number'], [e.charCode]);
    });

</script>

<script src="websocket.js"></script>    
<script src="index.js"></script>
<script src="my_dev_logic.js"></script>

</body>
</html>